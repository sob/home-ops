---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/cilium.io/ciliumloadbalancerippool_v2alpha1.json
apiVersion: cilium.io/v2alpha1
kind: CiliumLoadBalancerIPPool
metadata:
  name: cilium-pool
spec:
  blocks:
    - start: "${CILIUM_LB_RANGE_START}"
      stop: "${CILIUM_LB_RANGE_END}"
  disabled: false  # Set to true to disable during testing
  # Optional: disable automatic allocation for certain services
  # serviceSelector:
  #   matchExpressions:
  #   - key: io.cilium/manual-ip
  #     operator: NotIn
  #     values: ["true"]
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/cilium.io/ciliumloadbalancerippool_v2alpha1.json
apiVersion: cilium.io/v2alpha1
kind: CiliumLoadBalancerIPPool
metadata:
  name: dns-pool
spec:
  blocks:
    - start: "10.1.100.53"
      stop: "10.1.100.53"
  disabled: false
  serviceSelector:
    matchLabels:
      app.kubernetes.io/name: resolver-blocky
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/cilium.io/ciliuml2announcementpolicy_v2alpha1.json
apiVersion: cilium.io/v2alpha1
kind: CiliumL2AnnouncementPolicy
metadata:
  name: default-l2-announcement-policy
spec:
  # Announce all LoadBalancer services
  loadBalancerIPs: true
  # If you want to be more selective, use:
  # serviceSelector:
  #   matchLabels:
  #     io.cilium/l2-announce: "true"

  # Auto-detect interfaces or specify them
  # interfaces:
  # - eth0
  # - ens3

  # Select which nodes should announce IPs
  nodeSelector:
    matchLabels:
      kubernetes.io/os: linux
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/cilium.io/ciliumbgpclusterconfig_v2alpha1.json
apiVersion: cilium.io/v2alpha1
kind: CiliumBGPClusterConfig
metadata:
  name: bgp-cluster-config
spec:
  nodeSelector:
    matchExpressions:
      - key: node-role.kubernetes.io/control-plane
        operator: DoesNotExist
  bgpInstances:
    - name: main
      localASN: 65534
      peers:
        - name: udm-pro
          peerASN: 64512
          peerAddress: 10.1.100.1
          peerConfigRef:
            name: bgp-peer-config
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/cilium.io/ciliumbgppeerconfig_v2alpha1.json
apiVersion: cilium.io/v2alpha1
kind: CiliumBGPPeerConfig
metadata:
  name: bgp-peer-config
spec:
  authSecretRef: null
  gracefulRestart:
    enabled: true
    restartTimeSeconds: 120
  families:
    - afi: ipv4
      safi: unicast
      advertisements:
        matchLabels:
          advertise: bgp
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/cilium.io/ciliumbgpadvertisement_v2alpha1.json
apiVersion: cilium.io/v2alpha1
kind: CiliumBGPAdvertisement
metadata:
  name: bgp-advertisements
  labels:
    advertise: bgp
spec:
  advertisements:
    - advertisementType: Service
      service:
        addresses:
          - LoadBalancerIP
      selector:
        matchExpressions:
          - key: io.cilium/bgp-announce
            operator: NotIn
            values: ["false"]
