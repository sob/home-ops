---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: democratic-csi-iscsi
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-connect
  target:
    name: democratic-csi-iscsi
    template:
      engineVersion: v2
      data:
        driver-config-file.yaml: |
          driver: synology-iscsi
          httpConnection:
            protocol: https
            host: "{{ .DSM_IP }}"
            port: "{{ .DSM_PORT }}"
            username: "{{ .DSM_USERNAME }}"
            password: "{{ .DSM_PASSWORD }}"
            allowInsecure: false
            session: "democratic-csi"
            serialize: true
          iscsi:
            targetPortal: "{{ .DSM_IP }}[:{{ .DSM_PORT }}]"
            targetPortals: []
            interface: ""
            baseiqn: "iqn.2000-01.com.synology:csi."
            namePrefix: ""
            nameSuffix: ""

            lunTemplate:
              description: "{{ parameters.[csi.storage.k8s.io/pvc/namespace] }}-{{ parameters.[csi.storage.k8s.io/pvc/name] }}"
              type: "BLUN"

            lunSnapshotTemplate:
              is_locked: true
              # https://kb.synology.com/en-me/DSM/tutorial/What_is_file_system_consistent_snapshot
              is_app_consistent: true

            targetTemplate:
              auth_type: 0
              max_sessions: 0
  dataFrom:
    - extract:
        key: synology-csi
