# Blocky v0.24 DNS Configuration
# Security-hardened DNS resolver with adblocking

# Upstream DNS servers
upstreams:
  groups:
    default:
      # Forward to DNSCrypt-proxy for encrypted DNS
      - resolver-dnscrypt-proxy.network.svc.cluster.local:5053

# Custom DNS mappings for internal domains
customDNS:
  customTTL: 1h
  filterUnmappedTypes: true
  mapping: {}

# Conditional forwarding for specific domains
conditional:
  mapping:
    # Forward cluster.local to CoreDNS
    cluster.local: tcp+udp:10.96.0.10
    
# Adblocking configuration
blocking:
  # Deny lists (formerly blackLists)
  denylists:
    ads:
      - https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts
      - https://someonewhocares.org/hosts/zero/hosts
      - https://raw.githubusercontent.com/AdguardTeam/AdguardSDNSFilter/master/Filters/filter.txt
      - https://adaway.org/hosts.txt
    malware:
      - https://urlhaus.abuse.ch/downloads/hostfile/
      - https://malware-filter.gitlab.io/malware-filter/urlhaus-filter-hosts.txt
    tracking:
      - https://raw.githubusercontent.com/AdguardTeam/cname-trackers/master/data/combined_disguised_trackers.txt
  # Allow lists (formerly whiteLists)
  allowlists:
    ads:
      - https://raw.githubusercontent.com/anudeepND/whitelist/master/domains/whitelist.txt
  # Client-specific settings
  clientGroupsBlock:
    default:
      - ads
      - malware
      - tracking
  blockType: zeroIp
  blockTTL: 6h
  loading:
    refreshPeriod: 24h
    downloads:
      timeout: 60s
      attempts: 3
      cooldown: 5s
    strategy: failOnError

# Caching configuration (similar to Unbound's 4GB)
caching:
  minTime: 0s
  maxTime: 24h
  cacheTimeNegative: 30m
  prefetching: true
  prefetchExpires: 2h
  prefetchThreshold: 5
  prefetchMaxItemsCount: 0

# Extended DNS Errors (EDE) for DNSSEC and other failures
ede:
  enable: true

# Logging configuration
log:
  level: info
  format: text
  timestamp: true
  privacy: false

# Query logging for debugging (disable in production)
queryLog:
  type: none  # Options: none, csv, console, csv-client
  target: ""
  logRetentionDays: 0
  flushInterval: 30s

# Prometheus metrics
prometheus:
  enable: true
  path: /metrics

# Redis cache (optional, for HA setups)
redis:
  required: false
  address: ""
  database: 0
  connectionAttempts: 3
  connectionCooldown: 1s

# Port configuration
ports:
  dns: 53
  tls: 853   # DNS-over-TLS for encrypted client connections
  https: 443 # DNS-over-HTTPS for encrypted client connections  
  http: 4000 # API and metrics

# Host/interface binding
hostsFile:
  filePath: /etc/hosts
  hostsTTL: 60m
  refreshPeriod: 30m
  filterLoopback: true

# Client lookup for identifying requests
clientLookup:
  singleNameOrder:
    - 2
    - 1

# Bootstrap DNS servers (for resolving upstream hostnames)
bootstrapDns:
  - upstream: tcp+udp:10.96.0.10  # Use CoreDNS for bootstrap

# Filtering configuration
filtering:
  queryTypes: []  # Empty to allow all query types

# TLS configuration for client connections
minTlsServeVersion: 1.3

# Connection settings
connectIPVersion: dual

# FQDNs only - ensure domains have proper formatting
fqdnOnly:
  enable: true

# DoH User Agent (for upstream DoH connections if needed)
dohUserAgent: blocky