---
# Blocky v0.24 DNS Configuration
# Security-hardened DNS resolver with adblocking

# Upstream DNS servers
upstreams:
  groups:
    default:
      # Forward to DNSCrypt-proxy for encrypted DNS
      - resolver-dnscrypt-proxy.network.svc.cluster.local:5053
  userAgent: blocky

# Conditional forwarding for specific domains
conditional:
  mapping:
    # Forward cluster.local to CoreDNS
    cluster.local: tcp+udp:10.96.0.10

# Adblocking configuration
blocking:
  # Deny lists (formerly blackLists)
  denylists:
    hagezi:
      - https://raw.githubusercontent.com/hagezi/dns-blocklists/main/wildcard/pro.txt
      - https://raw.githubusercontent.com/hagezi/dns-blocklists/main/wildcard/tif.medium.txt
    adult:
  # Allow lists (formerly whiteLists)
  allowlists:
    self:
      - |
        *.${SECRET_DOMAIN}
  # Client-specific settings
  clientGroupsBlock:
    default:
      - hagezi
    family:
      - hagezi
      - adult
  blockType: zeroIp
  blockTTL: 6h
  loading:
    refreshPeriod: 8h
    downloads:
      timeout: 120s
      attempts: 5
      cooldown: 10s
    strategy: failOnError

# Caching configuration (similar to Unbound's 4GB)
caching:
  minTime: 0s
  maxTime: 24h
  cacheTimeNegative: 30m
  prefetching: true
  prefetchExpires: 2h
  prefetchThreshold: 5
  prefetchMaxItemsCount: 0

# Extended DNS Errors (EDE) for DNSSEC and other failures
ede:
  enable: true

# Logging configuration
log:
  level: info
  format: text
  timestamp: true
  privacy: false

# Query logging for debugging (disable in production)
queryLog:
  type: none  # Options: none, csv, console, csv-client
  target: ""
  logRetentionDays: 0
  flushInterval: 30s

# Prometheus metrics
prometheus:
  enable: true
  path: /metrics

# Redis cache (optional, for HA setups)
redis:
  required: false
  address: ""
  database: 0
  connectionAttempts: 3
  connectionCooldown: 1s

# Port configuration
ports:
  dns: 53
  tls: 853   # DNS-over-TLS for encrypted client connections
  https: 443 # DNS-over-HTTPS for encrypted client connections
  http: 4000 # API and metrics

# Client lookup for identifying requests
clientLookup:
  upstream: 10.1.0.1
  singleNameOrder:
    - 2
    - 1

# Bootstrap DNS servers (for resolving upstream hostnames)
bootstrapDns:
  - upstream: tcp+udp:10.96.0.10

# Filtering configuration
filtering:
  queryTypes: []  # Empty to allow all query types

# TLS configuration for client connections
minTlsServeVersion: 1.3
certFile: /app/cert/tls.crt
keyFile: /app/cert/tls.key

# Connection settings
connectIPVersion: v4

# FQDNs only - ensure domains have proper formatting
fqdnOnly:
  enable: true
