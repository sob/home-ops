---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: mosquitto
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-connect
  target:
    name: mosquitto-secret
    template:
      engineVersion: v2
      data:
        # Plaintext passwords - will be hashed by init container
        HASS_USER: "{{ .MQTT_HASS_USERNAME }}"
        HASS_PASS: "{{ .MQTT_HASS_PASSWORD }}"
        RATGDO_USER: "{{ .MQTT_RATGDO_USERNAME }}"
        RATGDO_PASS: "{{ .MQTT_RATGDO_PASSWORD }}"
        ZIGBEE_USER: "{{ .MQTT_ZIGBEE_USERNAME }}"
        ZIGBEE_PASS: "{{ .MQTT_ZIGBEE_PASSWORD }}"
        EXPORTER_USER: "{{ .MQTT_EXPORTER_USERNAME }}"
        EXPORTER_PASS: "{{ .MQTT_EXPORTER_PASSWORD }}"
        RTLAMR_USER: "{{ .MQTT_RTLAMR2MQTT_USERNAME }}"
        RTLAMR_PASS: "{{ .MQTT_RTLAMR2MQTT_PASSWORD }}"
        N8N_USER: "{{ .MQTT_N8N_USERNAME }}"
        N8N_PASS: "{{ .MQTT_N8N_PASSWORD }}"
        NODERED_USER: "{{ .MQTT_NODERED_USERNAME }}"
        NODERED_PASS: "{{ .MQTT_NODERED_PASSWORD }}"
        BATOCERA_USER: "{{ .MQTT_BATOCERA_USERNAME }}"
        BATOCERA_PASS: "{{ .MQTT_BATOCERA_PASSWORD }}"
        mosquitto.conf: |
          # Listeners
          listener 1883
          protocol mqtt

          # Authentication
          allow_anonymous false
          password_file /mosquitto-init/mosquitto.passwd

          # ACL - Allow all (matching EMQX behavior)
          acl_file /mosquitto/config/mosquitto.acl

          # Persistence
          persistence true
          persistence_location /mosquitto/data/

          # Logging
          log_dest stdout
          log_type error
          log_type warning
          log_type notice
          log_type information
          connection_messages true
        mosquitto.acl: |
          # Allow all topics (matching EMQX behavior)
          pattern readwrite #
  dataFrom:
    - extract:
        key: mqtt
