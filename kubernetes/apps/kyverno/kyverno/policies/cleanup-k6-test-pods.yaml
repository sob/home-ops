---
# Clean up succeeded k6 test initializer and starter pods after 1 minute
apiVersion: kyverno.io/v2
kind: ClusterCleanupPolicy
metadata:
  name: k6-initializer-starter-cleanup
spec:
  schedule: "*/1 * * * *"  # Run every minute
  match:
    any:
      - resources:
          kinds:
            - Pod
          namespaces:
            - observability
          selector:
            matchLabels:
              app: k6
  conditions:
    all:
      - key: "{{ target.status.phase }}"
        operator: Equals
        value: Succeeded
      - key: "{{ time_since('', target.metadata.creationTimestamp, '') }}"
        operator: GreaterThan
        value: 1m
      - key: "{{ contains(target.metadata.name, 'initializer') || contains(target.metadata.name, 'starter') }}"
        operator: Equals
        value: true
---
# Clean up succeeded k6 runner pods after 10 minutes
apiVersion: kyverno.io/v2
kind: ClusterCleanupPolicy
metadata:
  name: k6-runner-cleanup
spec:
  schedule: "*/1 * * * *"  # Run every minute
  match:
    any:
      - resources:
          kinds:
            - Pod
          namespaces:
            - observability
          selector:
            matchLabels:
              app: k6
  conditions:
    all:
      - key: "{{ target.status.phase }}"
        operator: Equals
        value: Succeeded
      - key: "{{ time_since('', target.metadata.creationTimestamp, '') }}"
        operator: GreaterThan
        value: 10m
      - key: "{{ !contains(target.metadata.name, 'initializer') && !contains(target.metadata.name, 'starter') }}"
        operator: Equals
        value: true
---
# Clean up failed k6 pods after 30 minutes for debugging
apiVersion: kyverno.io/v2
kind: ClusterCleanupPolicy
metadata:
  name: k6-failed-cleanup
spec:
  schedule: "*/2 * * * *"  # Run every 2 minutes
  match:
    any:
      - resources:
          kinds:
            - Pod
          namespaces:
            - observability
          selector:
            matchLabels:
              app: k6
  conditions:
    all:
      - key: "{{ target.status.phase }}"
        operator: Equals
        value: Failed
      - key: "{{ time_since('', target.metadata.creationTimestamp, '') }}"
        operator: GreaterThan
        value: 30m
---
# Clean up k6 scheduler pods (CronJob pods that create TestRuns)
apiVersion: kyverno.io/v2
kind: ClusterCleanupPolicy
metadata:
  name: k6-scheduler-cleanup
spec:
  schedule: "*/1 * * * *"  # Run every minute
  match:
    any:
      - resources:
          kinds:
            - Pod
          namespaces:
            - observability
          selector:
            matchLabels:
              app: k6-scheduler
  conditions:
    all:
      - key: "{{ target.status.phase == 'Succeeded' || target.status.phase == 'Failed' || target.status.phase == 'Completed' }}"
        operator: Equals
        value: true
      - key: "{{ time_since('', target.metadata.creationTimestamp, '') }}"
        operator: GreaterThan
        value: 5m